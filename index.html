<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ប្រព័ន្ធគ្រប់គ្រងសិស្ស - Student Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Battambang for Khmer, Poppins for English -->
    <link href="https://fonts.googleapis.com/css2?family=Battambang:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Battambang', 'Poppins', sans-serif;
            background-color: #f0f2f5;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .loader {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Glassmorphism utility */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col pb-20"> 

    <!-- 1. NAVBAR (Left Aligned & Bigger) -->
    <nav class="bg-gradient-to-r from-blue-700 to-blue-500 shadow-lg sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-start"> 
            <div class="flex items-center gap-3">
                <!-- BIGGER LOGO -->
                <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-md p-1">
                    <img src="https://i.postimg.cc/FHBn0Fdf/di3-copy.png" alt="Logo" class="w-full h-full object-contain">
                </div>
                <div>
                    <!-- BIGGER TEXT -->
                    <h1 class="text-white font-bold text-xl leading-tight tracking-wide">បញ្ជីឈ្មោះសិស្ស</h1>
                    <!-- BIGGER SUBTEXT -->
                    <p class="text-blue-100 text-xs font-medium">Student Database</p>
                </div>
            </div>
        </div>
    </nav>

    <!-- 2. MAIN CONTENT -->
    <main class="flex-grow max-w-2xl mx-auto w-full p-3 space-y-3">

        <!-- Search Box (Compact) -->
        <div class="bg-white rounded-xl shadow-sm p-1.5 sticky top-20 z-30 ring-1 ring-gray-200 transition-all duration-300" id="searchContainer">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400 text-sm"></i>
                </div>
                <input type="text" id="searchInput" 
                    class="block w-full pl-9 pr-4 py-2 bg-gray-50 border-none rounded-lg text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:bg-white transition-all text-sm font-medium" 
                    placeholder="ស្វែងរកអត្តលេខ (ឧ. 123)..."
                    autocomplete="off">
                
                <!-- Loading Indicator inside search -->
                <div id="searchLoader" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                    <div class="loader"></div>
                </div>
            </div>
        </div>

        <!-- Filter Status Banner -->
        <div id="filterBanner" class="hidden bg-orange-50 border border-orange-100 rounded-lg p-2 flex items-center justify-between animate-fade-in-down">
            <div class="flex items-center text-orange-700">
                <i class="fas fa-filter mr-2 text-xs"></i>
                <span class="font-bold text-xs">បញ្ជីអ្នកដែលគ្មានរូបថត (Missing Photos)</span>
            </div>
            <div class="text-[10px] text-orange-500 font-bold bg-orange-100 px-2 py-0.5 rounded-full" id="filterCount">...</div>
        </div>

        <!-- Results List -->
        <div id="resultsArea" class="space-y-2.5">
            <!-- Initial State / Empty State -->
            <div id="emptyState" class="text-center py-8 opacity-60">
                <i class="fas fa-id-card text-4xl text-gray-300 mb-2"></i>
                <p class="text-gray-500 text-sm">វាយបញ្ចូលអត្តលេខដើម្បីស្វែងរក</p>
            </div>
        </div>
        
        <!-- Loading Full Page -->
        <div id="fullPageLoader" class="hidden text-center py-8">
            <div class="inline-block loader w-8 h-8 border-4 border-blue-200 border-t-blue-600 mb-2"></div>
            <p class="text-gray-500 text-xs">កំពុងទាញយកទិន្នន័យ...</p>
        </div>

    </main>

    <!-- BACK TO TOP BUTTON (New) -->
    <button id="backToTopBtn" onclick="scrollToTop()" class="fixed bottom-20 right-4 z-30 bg-blue-600 text-white w-10 h-10 flex items-center justify-center rounded-full shadow-lg shadow-blue-500/40 hidden transition-all duration-300 hover:bg-blue-700 active:scale-90 transform translate-y-0 opacity-100">
        <i class="fas fa-arrow-up text-sm"></i>
    </button>

    <!-- 3. FOOTER NAVIGATION (Compact) -->
    <footer class="fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-gray-200 glass pb-safe transition-all duration-300 h-14">
        <div class="flex justify-around items-center max-w-2xl mx-auto h-full">
            
            <!-- Tab 1: Home/Search -->
            <button onclick="switchTab('home')" id="tabHome" class="flex flex-col items-center justify-center w-full h-full text-blue-600 relative group transition-colors">
                <div class="text-lg mb-0.5 transition-transform group-active:scale-90">
                    <i class="fas fa-search"></i>
                </div>
                <span class="text-[10px] font-bold">ស្វែងរក</span>
                <!-- Active Indicator -->
                <div class="absolute top-0 w-8 h-0.5 bg-blue-600 rounded-b-lg"></div>
            </button>

            <!-- Tab 2: Missing Photos (Filter) -->
            <button onclick="switchTab('missing')" id="tabMissing" class="flex flex-col items-center justify-center w-full h-full text-gray-400 relative group hover:text-gray-600 transition-colors">
                <div class="relative text-lg mb-0.5 transition-transform group-active:scale-90">
                    <i class="fas fa-camera-retro"></i>
                    <!-- Badge -->
                    <span id="missingBadge" class="hidden absolute -top-1.5 -right-2 bg-red-500 text-white text-[8px] font-bold px-1 py-0.5 rounded-full border border-white shadow-sm min-w-[16px]">0</span>
                </div>
                <span class="text-[10px] font-bold">ត្រូវថត</span>
                <div class="hidden absolute top-0 w-8 h-0.5 bg-red-500 rounded-b-lg"></div>
            </button>

        </div>
    </footer>

    <!-- 4. CAMERA MODAL -->
    <div id="cameraModal" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <div class="absolute top-0 w-full p-3 flex justify-between items-center z-10 bg-gradient-to-b from-black/70 to-transparent">
            <button onclick="closeCamera()" class="text-white bg-white/20 backdrop-blur-md p-2 rounded-full w-8 h-8 flex items-center justify-center">
                <i class="fas fa-times text-sm"></i>
            </button>
            <span class="text-white font-medium text-sm tracking-wide">ថតរូបសិស្ស</span>
            <div class="w-8"></div>
        </div>
        <div class="flex-grow relative bg-black flex items-center justify-center overflow-hidden">
            <video id="videoFeed" autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"></video>
            <canvas id="canvas" class="hidden"></canvas>
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="w-56 h-56 border-2 border-white/50 rounded-full box-border"></div>
            </div>
        </div>
        <div class="bg-black p-4 pb-8 flex justify-around items-center">
            <button class="text-white p-4 opacity-0"><i class="fas fa-sync text-xl"></i></button>
            <button onclick="capturePhoto()" class="w-16 h-16 bg-white rounded-full border-4 border-gray-300 flex items-center justify-center transform active:scale-90 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                <div class="w-12 h-12 bg-white rounded-full border-2 border-black"></div>
            </button>
            <button class="text-white p-4 opacity-0"><i class="fas fa-image text-xl"></i></button>
        </div>
    </div>

    <!-- 5. PREVIEW MODAL -->
    <div id="previewModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-3 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-800 text-sm">ពិនិត្យរូបថត</h3>
                <button onclick="closePreview()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 bg-gray-100 flex-grow flex items-center justify-center">
                <img id="previewImage" src="" class="w-40 h-40 rounded-full object-cover shadow-lg border-4 border-white">
            </div>
            <div class="p-4 space-y-2 bg-white border-t">
                <button onclick="uploadPhoto()" id="btnSave" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 transition-all text-sm">
                    <i class="fas fa-check"></i>
                    <span>រក្សាទុក (Save)</span>
                </button>
                <button onclick="retakePhoto()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-2.5 rounded-lg transition-all text-sm">
                    ថតម្តងទៀត (Retake)
                </button>
            </div>
            <div id="uploadingOverlay" class="absolute inset-0 bg-white/90 hidden flex flex-col items-center justify-center z-10">
                <div class="loader mb-3 !w-8 !h-8 !border-4"></div>
                <p class="text-gray-600 font-medium text-xs animate-pulse">កំពុងអាប់ឡូត...</p>
            </div>
        </div>
    </div>

    <!-- Firebase & Logic -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAc2g-t9A7du3K_nI2fJnw_OGxhmLfpP6s",
            authDomain: "dilistname.firebaseapp.com",
            databaseURL: "https://dilistname-default-rtdb.firebaseio.com",
            projectId: "dilistname",
            storageBucket: "dilistname.firebasestorage.app",
            messagingSenderId: "897983357871",
            appId: "1:897983357871:web:42a046bc9fb3e0543dc55a",
            measurementId: "G-NQ798D9J6K"
        };

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dttx1x743/image/upload";
        const CLOUDINARY_PRESET = "difulllist"; 

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let activeStudentId = null;
        let capturedBlob = null;
        let videoStream = null;
        let isMissingTab = false;
        let cachedAllData = null;
        let pendingList = [];

        // ==========================================
        // SCROLL TO TOP LOGIC (NEW)
        // ==========================================
        const backToTopBtn = document.getElementById('backToTopBtn');

        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                backToTopBtn.classList.remove('hidden');
                backToTopBtn.classList.add('flex'); // Use flex to center icon
            } else {
                backToTopBtn.classList.add('hidden');
                backToTopBtn.classList.remove('flex');
            }
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ==========================================
        // SEARCH & LISTENER LOGIC
        // ==========================================
        const searchInput = document.getElementById('searchInput');
        const resultsArea = document.getElementById('resultsArea');
        const searchLoader = document.getElementById('searchLoader');
        const emptyState = document.getElementById('emptyState');
        const fullPageLoader = document.getElementById('fullPageLoader');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (isMissingTab) {
                filterPendingList(query);
            } else {
                handleServerSearch(query);
            }
        });

        function handleServerSearch(query) {
            if (query.length === 0) {
                resultsArea.innerHTML = '';
                emptyState.classList.remove('hidden');
                resultsArea.appendChild(emptyState);
                searchLoader.classList.add('hidden');
                return;
            }

            searchLoader.classList.remove('hidden');
            emptyState.classList.add('hidden');

            db.ref('students').orderByKey().startAt(query).endAt(query + "\uf8ff").limitToFirst(20).once('value')
                .then(snapshot => {
                    searchLoader.classList.add('hidden');
                    resultsArea.innerHTML = '';

                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const data = { id: child.key, ...child.val() };
                            resultsArea.appendChild(createStudentCard(data));
                        });
                    } else {
                        resultsArea.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">មិនមានទិន្នន័យ (No Data)</div>`;
                    }
                });
        }

        function fetchAllDataForPending() {
            if (cachedAllData) {
                processPendingData();
                return;
            }
            fullPageLoader.classList.remove('hidden');
            resultsArea.innerHTML = '';
            emptyState.classList.add('hidden');

            db.ref('students').limitToFirst(1000).once('value')
                .then(snapshot => {
                    fullPageLoader.classList.add('hidden');
                    cachedAllData = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            cachedAllData.push({ id: child.key, ...child.val() });
                        });
                        processPendingData();
                    } else {
                        resultsArea.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">Database Empty</div>`;
                    }
                });
        }

        function processPendingData() {
            pendingList = cachedAllData.filter(s => !s['រូបថត'] || s['រូបថត'] === 'n/a' || s['រូបថត'] === "");
            updateMissingBadge(pendingList.length);
            document.getElementById('filterCount').innerText = `${pendingList.length} នាក់`;
            filterPendingList(searchInput.value);
        }

        function filterPendingList(query) {
            resultsArea.innerHTML = '';
            const filtered = pendingList.filter(s => {
                const searchStr = query.toLowerCase();
                const idMatch = s.id.toString().includes(searchStr);
                const nameMatch = (s['ឈ្មោះ'] || "").toLowerCase().includes(searchStr);
                return idMatch || nameMatch;
            });

            if (filtered.length === 0) {
                resultsArea.innerHTML = `<div class="text-center py-8 text-gray-400 text-sm">រកមិនឃើញក្នុងបញ្ជីនេះទេ</div>`;
                return;
            }
            filtered.forEach(student => {
                resultsArea.appendChild(createStudentCard(student));
            });
        }

        // ==========================================
        // COMPACT UI COMPONENTS
        // ==========================================
        function createStudentCard(data) {
            const hasImage = data['រូបថត'] && data['រូបថត'] !== "" && data['រូបថត'] !== "n/a";
            const imageUrl = hasImage ? data['រូបថត'] : "https://via.placeholder.com/150/e2e8f0/94a3b8?text=No+Img";
            
            // Status Styling - UPDATED for "Active" with checkmark
            const statusColor = hasImage ? "bg-green-100 text-green-700 border-green-200" : "bg-red-50 text-red-600 border-red-100";
            const statusText = hasImage ? "Active" : "ត្រូវថត (Pending)";
            const statusIcon = hasImage ? "fa-check-circle" : "fa-exclamation-circle";

            const div = document.createElement('div');
            // COMPACT STYLES HERE: p-3, gap-3, smaller height
            div.className = "bg-white rounded-xl p-3 shadow-sm border border-gray-100 flex items-center gap-3 transition-transform active:scale-[0.99]";
            div.innerHTML = `
                <div class="relative shrink-0 group" onclick="${!hasImage ? `openCamera('${data.id}')` : ''}">
                    <!-- Smaller Image (w-12 h-12) -->
                    <img src="${imageUrl}" class="w-12 h-12 rounded-full object-cover border-2 ${hasImage ? 'border-green-400' : 'border-red-300'}">
                    ${!hasImage ? `<div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center cursor-pointer backdrop-blur-[1px] animate-pulse"><i class="fas fa-camera text-white text-xs"></i></div>` : ''}
                </div>
                <div class="flex-grow min-w-0">
                    <div class="flex justify-between items-start">
                        <!-- Compact Text -->
                        <h3 class="font-bold text-gray-800 text-base truncate leading-tight">${data['ឈ្មោះ'] || "Unknown"}</h3>
                        <!-- EDIT BUTTON REMOVED -->
                    </div>
                    <p class="text-gray-500 text-xs mb-1.5 truncate">${data['ជំនាញ'] || "N/A"}</p>
                    <div class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium border ${statusColor}">
                        <i class="fas ${statusIcon} mr-1.5"></i>${statusText}
                        <span class="ml-1.5 text-gray-400 font-mono opacity-70">#${data.id}</span>
                    </div>
                </div>
                ${!hasImage ? `<button onclick="openCamera('${data.id}')" class="shrink-0 w-8 h-8 bg-red-50 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100"><i class="fas fa-camera text-sm"></i></button>` : ''}
            `;
            return div;
        }

        // ==========================================
        // FOOTER TABS LOGIC
        // ==========================================
        function switchTab(tab) {
            const tabHome = document.getElementById('tabHome');
            const tabMissing = document.getElementById('tabMissing');
            const filterBanner = document.getElementById('filterBanner');
            
            tabHome.className = "flex flex-col items-center justify-center w-full h-full relative group text-blue-600 transition-colors";
            tabHome.querySelector('div:last-child').classList.add('hidden');
            tabMissing.className = "flex flex-col items-center justify-center w-full h-full relative group text-gray-400 hover:text-gray-600 transition-colors";
            tabMissing.querySelector('div:last-child').classList.add('hidden');

            if (tab === 'home') {
                isMissingTab = false;
                searchInput.value = '';
                searchInput.placeholder = "ស្វែងរកអត្តលេខ (ឧ. 123)...";
                tabHome.className = "flex flex-col items-center justify-center w-full h-full relative group text-blue-600 transition-colors";
                tabHome.querySelector('div:last-child').classList.remove('hidden');
                filterBanner.classList.add('hidden');
                resultsArea.innerHTML = '';
                emptyState.classList.remove('hidden');
                resultsArea.appendChild(emptyState);

            } else if (tab === 'missing') {
                isMissingTab = true;
                searchInput.value = '';
                searchInput.placeholder = "ស្វែងរក (ឈ្មោះ/លេខ)...";
                tabMissing.className = "flex flex-col items-center justify-center w-full h-full relative group text-red-500 transition-colors";
                tabMissing.querySelector('div:last-child').classList.remove('hidden');
                filterBanner.classList.remove('hidden');
                fetchAllDataForPending();
            }
        }

        function updateMissingBadge(count) {
            const badge = document.getElementById('missingBadge');
            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ==========================================
        // CAMERA LOGIC
        // ==========================================
        // EDIT LOGIC REMOVED

        function openCamera(id) {
            activeStudentId = id;
            document.getElementById('cameraModal').classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => { videoStream = stream; document.getElementById('videoFeed').srcObject = stream; })
                .catch(err => { alert("Camera Error"); closeCamera(); });
        }
        function closeCamera() {
            if (videoStream) videoStream.getTracks().forEach(t => t.stop());
            document.getElementById('cameraModal').classList.add('hidden');
        }
        function capturePhoto() {
            const video = document.getElementById('videoFeed');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            capturedBlob = canvas.toDataURL('image/jpeg');
            closeCamera();
            document.getElementById('previewImage').src = capturedBlob;
            document.getElementById('previewModal').classList.remove('hidden');
        }
        function retakePhoto() {
            document.getElementById('previewModal').classList.add('hidden');
            openCamera(activeStudentId);
        }
        function closePreview() { document.getElementById('previewModal').classList.add('hidden'); }
        function uploadPhoto() {
            if (!capturedBlob) return;
            document.getElementById('uploadingOverlay').classList.remove('hidden');
            const formData = new FormData();
            formData.append('file', capturedBlob);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            fetch(CLOUDINARY_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => { if (data.secure_url) saveToFirebase(data.secure_url); })
            .catch(err => { alert("Upload Failed"); document.getElementById('uploadingOverlay').classList.add('hidden'); });
        }
        function saveToFirebase(url) {
            db.ref('students/' + activeStudentId).update({ 'រូបថត': url }).then(() => {
                document.getElementById('uploadingOverlay').classList.add('hidden');
                document.getElementById('previewModal').classList.add('hidden');
                if (isMissingTab) {
                    const idx = cachedAllData.findIndex(s => s.id === activeStudentId);
                    if(idx !== -1) cachedAllData[idx]['រូបថត'] = url;
                    processPendingData();
                } else {
                    handleServerSearch(searchInput.value);
                }
            });
        }
    </script>
</body>
</html>